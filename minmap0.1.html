<!DOCTYPE html>
<html>
  <head>
    <title>Mind Map</title>
    <style>
      canvas {
        border: 1px solid black;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="600" height="300"></canvas>
    <input type="text" id="hidden-input" style="opacity: 0; position: absolute; top: 0; left: 0;" />
    <button id="delete-button" style="position: absolute; top: 10px; right: 10px; width: 6ch; display: none;">Del</button>
    <script>
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      canvas.width = (screen.width)*0.92;
      canvas.height = (screen.height)*0.8;          
      const hiddenInput = document.getElementById('hidden-input');
      const deleteButton = document.getElementById("delete-button");
      var nodes = [];let selectedNodeIndex = -1; 
      let lastTouchTime = 0;let drag = 0;
      const radiusX = 60;const radiusY = 28;
      var torm=[];
  
      function drawNode(node) {
        context.beginPath();
        if (nodes.indexOf(node) === selectedNodeIndex){
          context.lineWidth = 1;context.setLineDash([8, 11]);;context.beginPath();context.ellipse(node.x, node.y, radiusX+9, radiusY+10, 0, 0, 2 * Math.PI);
          context.stroke();context.beginPath();
          context.lineWidth = 1;context.setLineDash([]);
          const deleteButtonX = node.x + radiusX + 10;
          const deleteButtonY = node.y - radiusY - 20;
          deleteButton.style.left = `${deleteButtonX}px`;
          deleteButton.style.top = `${deleteButtonY}px`;
          deleteButton.style.display = "block";}
        context.ellipse(node.x, node.y, radiusX, radiusY, 0, 0, 2 * Math.PI);
        if (nodes.indexOf(node) === 0) {
          context.fillStyle = "rgb(160, 160, 160)";context.fill();
          context.stroke();context.font = "16px Arial";context.fillStyle = "black";
          context.textAlign = "center";context.fillText(node.label, node.x, node.y + 5);
        } else {
          context.fillStyle = "white";context.fill();
          context.stroke();context.font = "16px Arial";context.fillStyle = "black";
          context.textAlign = "center";context.fillText(node.label, node.x, node.y + 5);};}
        
      function addNode(x, y) {
        const node = { x, y, label: "", children: [] };
        if (selectedNodeIndex !== -1) {nodes[selectedNodeIndex].children.push(nodes.length);}
        nodes.push(node);
        selectedNodeIndex = nodes.length - 1; // set the selectedNodeIndex to the index of the new node
        hiddenInput.value = "";redraw();}

      function redraw() {
        hiddenInput.focus();
        context.clearRect(0, 0, canvas.width, canvas.height);
        if (selectedNodeIndex === -1) {deleteButton.style.display = "none";return;}
        nodes.forEach((node, index) => {
          node.children.forEach((childIndex) => {
            const child = nodes[childIndex];
            context.beginPath();
            context.moveTo(node.x, node.y);
            context.lineTo(child.x, child.y);
            context.stroke();
          });
          drawNode(node);}
        );
      }

      function handlePointerDown(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const node = nodes.find(
          (node) =>
            x >= node.x - radiusX &&
            x <= node.x + radiusX &&
            y >= node.y - radiusY &&
            y <= node.y + radiusY);        
        hiddenInput.focus();         
      	event.preventDefault();
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTouchTime;
        lastTouchTime = currentTime;
        if (tapLength < 500 && tapLength > 100) {
          if (node) {
            var ev = document.createEvent('HTMLEvents');
          } else {
            addNode(x, y);redraw()}
        } else {
          if (node) {
            selectedNodeIndex = nodes.indexOf(node);   
            hiddenInput.value=node.label
            redraw();drag=1}
          }
      }

      function handlePointerMove(event) {
        hiddenInput.focus();
        event.preventDefault();
        if (drag) {
          const rect = canvas.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;
          const dx = x - nodes[selectedNodeIndex].x;
          const dy = y - nodes[selectedNodeIndex].y;
          moveNode(selectedNodeIndex, dx, dy);
          redraw();
        } else {
          redraw();}
      }

      function moveNode(index, dx, dy) {
        nodes[index].x += dx;
        nodes[index].y += dy;
        nodes[index].children.forEach((childIndex) => {
          moveNode(childIndex, dx, dy);
        });}
      
      function deleteSelectedNode(event) {
        if (selectedNodeIndex === 0) {
          selectedNodeIndex = -1;
          nodes.splice(0);
        } else { 
          torm=[];        
          const prentNodeIndex = nodes.findIndex((prent) => prent.children.includes(selectedNodeIndex));          
          const nodeChildIndex = nodes[prentNodeIndex].children.indexOf(selectedNodeIndex);
          console.log('before nodes:', nodes);
          deleteSubtree(selectedNodeIndex); //get array of torm
          torm.push(selectedNodeIndex)
          torm.sort((a, b) => b - a);
          for (var i = 0; i < torm.length; i++) {
                nodes.splice(torm[i], 1);
                nodes.forEach((node) => {
                  for (var j = 0; j < node.children.length; j++) {
                    if (node.children[j] > torm[i]) {
                      node.children[j]--;}}
                });}
          nodes[prentNodeIndex].children.splice(nodeChildIndex, 1);
          selectedNodeIndex = prentNodeIndex;}           
          redraw();}

      function deleteSubtree(index) {
        nodes[index].children.forEach((childIndex) => {
          torm.push(childIndex);
          deleteSubtree(childIndex);});}
      function handlePointerUp(event) {drag=0;hiddenInput.focus();event.preventDefault();}
      function handleKeys(event) {if (selectedNodeIndex !== -1) {nodes[selectedNodeIndex].label = hiddenInput.value;redraw();}}
          
      canvas.addEventListener("pointerdown", handlePointerDown);
      canvas.addEventListener("pointermove", handlePointerMove);
      canvas.addEventListener("pointerup", handlePointerUp);
      canvas.addEventListener("mouseout", handlePointerUp); 
      hiddenInput.addEventListener('input', handleKeys);
      deleteButton.addEventListener("click", deleteSelectedNode);           
    </script>
  </body>
</html>
